<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Random Pattern AR</title>
    
    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    
    <!-- MindAR + A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            font-family: sans-serif;
        }
        
        #loading.hidden {
            display: none;
        }
        
        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-family: sans-serif;
            font-size: 14px;
            z-index: 100;
        }
        
        /* p5.js ìº”ë²„ìŠ¤ë¥¼ ìˆ¨ê¹€ (í…ìŠ¤ì²˜ë¡œë§Œ ì‚¬ìš©) */
        #p5-canvas-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading">
        <h2>AR ë¡œë”© ì¤‘...</h2>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
    </div>
    
    <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div id="instructions">
        ğŸ“± í¬ìŠ¤í„°ë¥¼ ì¹´ë©”ë¼ë¡œ ë¹„ì¶°ë³´ì„¸ìš”
    </div>
    
    <!-- p5.js ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ (ë³´ì´ì§€ ì•ŠìŒ) -->
    <div id="p5-canvas-container"></div>
    
    <!-- AR Scene -->
    <a-scene
        mindar-image="imageTargetSrc: ./targets/targets.mind; filterMinCF:0.001; filterBeta: 10; uiScanning: none; uiLoading: no;"
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <!-- AR ì½˜í…ì¸ : í¬ìŠ¤í„° ì¸ì‹ ì‹œ í‘œì‹œë  ë‚´ìš© -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- p5.js ìº”ë²„ìŠ¤ë¥¼ í…ìŠ¤ì²˜ë¡œ ì‚¬ìš©í•˜ëŠ” í‰ë©´ (A2 ë¹„ìœ¨: 1:1.414) -->
            <a-plane 
                id="pattern-plane"
                position="0 0 0" 
                rotation="0 0 0"
                width="1" 
                height="1.414"
                material="shader: flat; transparent: true">
            </a-plane>
        </a-entity>
        
        <!-- ì¹´ë©”ë¼ -->
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    </a-scene>
    
    <!-- p5.js íŒ¨í„´ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ (sketch.jsì™€ ë™ì¼) -->
    <script src="../js/sketch.js"></script>
    
    <script>
        // ARìš© setup ì˜¤ë²„ë¼ì´ë“œ
        let originalSetup = setup;
        setup = function() {
            // ARìš© ìº”ë²„ìŠ¤ ìƒì„± (800x1131ì„ AR í‰ë©´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì •)
            let canvas = createCanvas(800, 1131);
            canvas.parent('p5-canvas-container');
            background(0);
            noLoop();
            
            // SVGë¥¼ ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ë°°ì¹˜í•˜ê¸° ìœ„í•œ ì˜¤í”„ì…‹ ê³„ì‚°
            svgOffsetX = (width - svgOriginalWidth * svgScale) / 2;
            svgOffsetY = (height - svgOriginalHeight * svgScale) / 2;
            
            // íŒ¨í„´ ìë™ ì‹œì‘
            drawLineAcross();
            
            // A-Frame í‰ë©´ì— ìº”ë²„ìŠ¤ í…ìŠ¤ì²˜ ì ìš©
            setTimeout(() => {
                const plane = document.getElementById('pattern-plane');
                const canvas = document.querySelector('#p5-canvas-container canvas');
                if (plane && canvas) {
                    plane.setAttribute('material', {
                        shader: 'flat',
                        src: canvas,
                        transparent: false
                    });
                }
            }, 1000);
        };
        
        // ARìš© draw ì˜¤ë²„ë¼ì´ë“œ (í…ìŠ¤ì²˜ ì—…ë°ì´íŠ¸ ì¶”ê°€)
        let originalDraw = draw;
        draw = function() {
            if (isDrawing) {
                // SVG í´ë¦¬í•‘ ì ìš© (ìº”ë²„ìŠ¤ ì¢Œí‘œê³„)
                drawingContext.save();
                
                // SVG ìœ„ì¹˜ì™€ í¬ê¸°ì— ë§ì¶° ë³€í™˜ ì ìš©
                drawingContext.translate(svgOffsetX, svgOffsetY);
                drawingContext.scale(svgScale, svgScale);
                
                // í´ë¦¬í•‘ íŒ¨ìŠ¤ ìƒì„± ë° ì ìš©
                let path = new Path2D(svgPath);
                drawingContext.clip(path);
                
                // ë³€í™˜ ì·¨ì†Œ (ì ì„ ìº”ë²„ìŠ¤ ì¢Œí‘œê³„ë¡œ ê·¸ë¦¬ê¸° ìœ„í•´)
                drawingContext.scale(1/svgScale, 1/svgScale);
                drawingContext.translate(-svgOffsetX, -svgOffsetY);
                
                // ëª¨ë“  ì  ì—…ë°ì´íŠ¸
                updateDot(1);
                updateDot(2);
                updateDot(3);
                updateDot(4);
                updateDot(5);
                updateDot(6);
                updateDot(7);
                updateDot(8);
                
                drawingContext.restore();
                
                // SVG ìœ¤ê³½ì„ ì„ ìµœìƒë‹¨ì— ê·¸ë¦¬ê¸°
                drawingContext.save();
                drawingContext.translate(svgOffsetX, svgOffsetY);
                drawingContext.scale(svgScale, svgScale);
                let svgPath2 = new Path2D(svgPath);
                drawingContext.strokeStyle = '#000000';
                drawingContext.lineWidth = svgBorderWidth;
                drawingContext.lineCap = 'round';
                drawingContext.lineJoin = 'round';
                drawingContext.stroke(svgPath2);
                drawingContext.restore();
                
                // A-Frame í…ìŠ¤ì²˜ ì—…ë°ì´íŠ¸
                const plane = document.getElementById('pattern-plane');
                if (plane && plane.components.material && plane.components.material.material) {
                    const material = plane.components.material.material;
                    if (material.map) {
                        material.map.needsUpdate = true;
                    }
                }
            }
        };
    </script>
    
    <script>
        // AR Scene ì´ë²¤íŠ¸
        const sceneEl = document.querySelector('a-scene');
        const loadingEl = document.getElementById('loading');
        const instructionsEl = document.getElementById('instructions');
        
        sceneEl.addEventListener('loaded', () => {
            loadingEl.classList.add('hidden');
        });
        
        const target = document.querySelector('[mindar-image-target]');
        
        target.addEventListener('targetFound', () => {
            console.log('í¬ìŠ¤í„° ì¸ì‹ë¨!');
            instructionsEl.textContent = 'âœ¨ íŒ¨í„´ ìƒì„± ì¤‘';
            
            // ì¬ì¸ì‹ ì‹œ íŒ¨í„´ ë¦¬ì…‹
            if (typeof drawLineAcross === 'function') {
                drawLineAcross();
            }
        });
        
        target.addEventListener('targetLost', () => {
            console.log('í¬ìŠ¤í„° ë†“ì¹¨');
            instructionsEl.textContent = 'ğŸ“± í¬ìŠ¤í„°ë¥¼ ì¹´ë©”ë¼ë¡œ ë¹„ì¶°ë³´ì„¸ìš”';
        });
    </script>
</body>
</html>

