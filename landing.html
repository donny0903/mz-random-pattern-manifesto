<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MZ-RAM</title>
    <link rel="stylesheet" href="css/landingStyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="js/sketch2.js"></script>
</head>
<body>
    <div id="landing-background"></div>
    <audio id="bgm" loop preload="auto"></audio>
    
    <!-- 시작 화면: RANDOM ACCESS 버튼만 -->
    <div id="start-screen" class="screen active">
        <button class="access-button" onclick="startExperience()">RANDOM ACCESS</button>
    </div>
    
    <!-- 컨텐츠 화면: QR 코드 등 -->
    <div id="content-screen" class="screen">
        <div class="container">
            <h1>RANDOM ACCESS MEMORY</h1>
            
            <div class="track-list">
                <div class="track-item">1. "Give Life Back to Music"</div>
                <div class="track-item">2. "The Game of Love"</div>
                <div class="track-item">3. "Giorgio by Moroder"</div>
                <div class="track-item">4. "Within"</div>
                <div class="track-item">5. "Instant Crush"</div>
                <div class="track-item">6. "Lose Yourself to Dance"</div>
                <div class="track-item">7. "Touch"</div>
                <div class="track-item">8. "Get Lucky"</div>
                <div class="track-item">9. "Beyond"</div>
                <div class="track-item">10. "Motherboard"</div>
                <div class="track-item">11. "Fragments of Time"</div>
                <div class="track-item">12. "Doin' It Right"</div>
                <div class="track-item">13. "Contact"</div>
            </div>
        </div>
        
        <!-- FAB 버튼 -->
        <button class="fab" onclick="openQRModal()">AR Poster</button>
    </div>
    
    <!-- QR 모달 -->
    <div id="qr-modal" class="modal" onclick="closeQRModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="qr-container">
                <img src="asset/qr.png" alt="QR Code">
            </div>
        </div>
    </div>
    
    <script>
        // 현재 활성화된 트랙 인덱스 (0-based)
        let currentTrackIndex = null;
        // 트랙별 오디오 파일 경로 (1번 트랙 => asset/1.mp3 형태로 매핑)
        const trackAudioFiles = [
            'asset/1.mp3',
            'asset/2.mp3',
            'asset/3.mp3',
            'asset/4.mp3',
            'asset/5.mp3',
            'asset/6.mp3',
            'asset/7.mp3',
            'asset/8.mp3',
            'asset/9.mp3',
            'asset/10.mp3',
            'asset/11.mp3',
            'asset/12.mp3',
            'asset/13.mp3',
        ];

        function playTrackByIndex(index) {
            if (index == null || index < 0 || index >= trackAudioFiles.length) return;

            const audio = document.getElementById('bgm');
            const nextSrc = trackAudioFiles[index];

            // 동일 트랙이면 다시 재생만 시도
            if (currentTrackIndex === index && audio.src && audio.src.endsWith(nextSrc)) {
                audio.play().catch(err => console.log('Audio play failed:', err));
                return;
            }

            // 소스 교체 후 로드
            audio.src = nextSrc;
            audio.load();
            currentTrackIndex = index;
            audio.play().catch(err => console.log('Audio play failed:', err));
        }

        function startExperience() {
            // 패턴 그리기 시작
            if (typeof drawLineAcross === 'function') {
                drawLineAcross();
            }

            // 첫 트랙(1.mp3) 즉시 재생
            if (typeof playTrackByIndex === 'function') {
                playTrackByIndex(0);
            }
            
            // 화면 전환
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('content-screen').classList.add('active');
            
            // 1번 트랙 자동 재생
            playTrackByIndex(0);

            // 스크롤 인터랙션 초기화
            setTimeout(() => {
                initScrollInteraction();
            }, 500);
        }
        
        function openQRModal() {
            document.getElementById('qr-modal').classList.add('active');
        }
        
        function closeQRModal() {
            document.getElementById('qr-modal').classList.remove('active');
        }
        
        function initScrollInteraction() {
            const trackList = document.querySelector('.track-list');
            const trackItems = Array.from(document.querySelectorAll('.track-item'));
            const contentScreen = document.getElementById('content-screen');
            
            // HTML 재구성: 각 트랙을 스크롤 섹션으로 감싸기
            trackList.innerHTML = '';
            
            trackItems.forEach((item, index) => {
                const section = document.createElement('div');
                section.className = 'scroll-section';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'track-item-wrapper';
                
                const newItem = item.cloneNode(true);
                wrapper.appendChild(newItem);
                section.appendChild(wrapper);
                trackList.appendChild(section);
            });
            
            // 스크롤 이벤트 리스너
            const sections = document.querySelectorAll('.scroll-section');
            
            function updateActiveTrack() {
                const scrollTop = contentScreen.scrollTop;
                const viewportCenter = scrollTop + window.innerHeight / 2;

                let nearestIndex = null;
                let minDistance = Infinity;
                
                sections.forEach((section, index) => {
                    const rect = section.getBoundingClientRect();
                    const sectionTop = scrollTop + rect.top;
                    const sectionCenter = sectionTop + section.offsetHeight / 2;
                    const distance = Math.abs(viewportCenter - sectionCenter);
                    
                    const trackItem = section.querySelector('.track-item');
                    const isFirst = index === 0;
                    const isLast = index === sections.length - 1;

                    let shouldActive = false;
                    let compareDistance = distance;
                    
                    // 첫 번째 트랙: 화면 중앙이 첫 섹션 중앙 이전이면 항상 활성화
                    if (isFirst && viewportCenter <= sectionCenter) {
                        shouldActive = true;
                        compareDistance = 0;
                    }
                    // 마지막 트랙: 화면 중앙이 마지막 섹션 중앙 이후면 항상 활성화
                    else if (isLast && viewportCenter >= sectionCenter) {
                        shouldActive = true;
                        compareDistance = 0;
                    }
                    // 중간 트랙: 화면 중앙에 가까우면 활성화
                    else if (distance < 200) {
                        shouldActive = true;
                    }

                    if (shouldActive) {
                        trackItem.classList.add('active');
                        if (compareDistance < minDistance) {
                            minDistance = compareDistance;
                            nearestIndex = index;
                        }
                    } else {
                        trackItem.classList.remove('active');
                    }
                });

                // 가장 가까운 트랙에 맞춰 오디오 변경
                if (nearestIndex !== null && nearestIndex !== currentTrackIndex) {
                    playTrackByIndex(nearestIndex);
                }
            }
            
            contentScreen.addEventListener('scroll', updateActiveTrack);
            
            // 초기 첫 트랙 활성화 + 오디오 재생
            setTimeout(() => {
                updateActiveTrack();
            }, 100);
        }
    </script>
</body>
</html>

